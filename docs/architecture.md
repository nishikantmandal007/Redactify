# üèóÔ∏è Redactify Architecture Documentation

<div align="center">

![Architecture](https://img.shields.io/badge/Architecture-Documentation-blue?style=for-the-badge)
![Python](https://img.shields.io/badge/Python-Modular%20Design-green?style=for-the-badge)

*Comprehensive system design and component documentation*

</div>

---

## üìã Table of Contents

- [üåü System Overview](#-system-overview)
- [üèóÔ∏è High-Level Architecture](#Ô∏è-high-level-architecture)
- [üì¶ Module Structure](#-module-structure)
- [üîÑ Data Flow](#-data-flow)
- [üéØ Component Details](#-component-details)
- [üîß Design Patterns](#-design-patterns)
- [üöÄ Scalability](#-scalability)
- [üîí Security Architecture](#-security-architecture)

---

## üåü System Overview

Redactify is built as a **modular, microservice-oriented** application using Flask for the web layer and Celery for asynchronous task processing. The architecture follows **separation of concerns** principles with clear boundaries between different functional areas.

### üéØ Core Design Principles

1. **Modularity** - Each component has a single responsibility
2. **Scalability** - Horizontal scaling through worker processes
3. **Reliability** - Error handling and graceful degradation
4. **Security** - Secure file handling and data protection
5. **Performance** - GPU acceleration and optimized processing
6. **Maintainability** - Clean code and comprehensive testing

---

## üèóÔ∏è High-Level Architecture

## üèóÔ∏è High-Level Architecture

```mermaid
graph TB
    subgraph "Client Layer"
        UI[Web Interface]
        API[API Clients]
    end
    
    subgraph "Web Layer"
        AF[App Factory]
        RT[Routes & Forms]
        WS[Web Services]
    end
    
    subgraph "Task Queue Layer"
        CS[Celery Service]
        TK[Background Tasks]
        RD[Redis Broker]
    end
    
    subgraph "Processing Layer"
        subgraph "Core Services"
            AZ[Analyzers Engine]
            RX[Redaction Service]
            CL[Cleanup Service]
        end
        
        subgraph "Document Processors"
            DP[Digital PDF Processor]
            SP[Scanned PDF Processor]
            IP[Image Processor]
            QR[QR Code Processor]
            MP[Metadata Processor]
        end
        
        subgraph "AI/ML Components"
            PR[Presidio NLP]
            PO[PaddleOCR]
            CR[Custom Recognizers]
            GPU[GPU Utils]
        end
    end
    
    subgraph "Configuration Layer"
        CF[Core Config]
        PT[PII Types]
        ET[Entity Types]
    end
    
    subgraph "Storage Layer"
        TF[Temp Files]
        UF[Upload Files]
        RF[Result Files]
    end
    
    %% Connections
    UI --> AF
    API --> RT
    AF --> RT
    RT --> CS
    CS --> TK
    TK --> RD
    
    TK --> AZ
    TK --> RX
    TK --> CL
    
    AZ --> DP
    AZ --> SP
    AZ --> IP
    AZ --> QR
    AZ --> MP
    
    DP --> PR
    SP --> PO
    IP --> PO
    DP --> CR
    SP --> CR
    IP --> CR
    
    PO --> GPU
    PR --> GPU
    
    AZ --> CF
    AZ --> PT
    CR --> ET
    
    TK --> TF
    TK --> UF
    TK --> RF
```

### üéØ Architecture Layers

| Layer | Purpose | Components |
|-------|---------|------------|
| **Client** | User interaction | Web UI, REST API clients |
| **Web** | Request handling | Flask app factory, routes, forms |
| **Task Queue** | Async processing | Celery workers, Redis message broker |
| **Processing** | Core business logic | Document processors, AI engines, services |
| **Configuration** | System configuration | Config management, PII type definitions |
| **Storage** | File management | Temporary files, uploads, results |

        Flask[Flask Application]
        Routes[Route Handlers]
        Forms[Form Processing]
    end
    
    subgraph "Task Queue Layer"
        Redis[(Redis)]
        Celery[Celery Workers]
        Beat[Celery Beat Scheduler]
    end
    
    subgraph "Processing Layer"
        ProcessorManager[Processor Manager]
        PDFProcessor[PDF Processor]
        ImageProcessor[Image Processor]
        OCREngine[OCR Engine]
    end
    
    subgraph "AI/ML Layer"
        Presidio[Presidio NLP]
        PaddleOCR[PaddleOCR]
        CustomRecognizers[Custom Recognizers]
        SpaCy[spaCy Models]
    end
    
    subgraph "Storage Layer"
        TempFiles[(Temporary Files)]
        UploadFiles[(Upload Files)]
        ProcessedFiles[(Processed Files)]
    end
    
    UI --> Flask
    API --> Flask
    Flask --> Routes
    Routes --> Forms
    Routes --> Celery
    Celery --> Redis
    Beat --> Redis
    Celery --> ProcessorManager
    ProcessorManager --> PDFProcessor
    ProcessorManager --> ImageProcessor
    PDFProcessor --> OCREngine
    ImageProcessor --> OCREngine
    OCREngine --> PaddleOCR
    ProcessorManager --> Presidio
    Presidio --> SpaCy
    Presidio --> CustomRecognizers
    ProcessorManager --> TempFiles
    ProcessorManager --> UploadFiles
    ProcessorManager --> ProcessedFiles

```

---

## üì¶ Module Structure

### üóÇÔ∏è Directory Layout

```

Redactify/
‚îú‚îÄ‚îÄ üè† **init**.py              # Package initialization
‚îú‚îÄ‚îÄ üöÄ main.py                  # Application entry point
‚îú‚îÄ‚îÄ üì± app.py                   # Legacy Flask app (deprecated)
‚îÇ
‚îú‚îÄ‚îÄ üß† core/                    # Core system components
‚îÇ   ‚îú‚îÄ‚îÄ analyzers.py            # PII analysis engine setup
‚îÇ   ‚îú‚îÄ‚îÄ config.py               # Configuration management
‚îÇ   ‚îî‚îÄ‚îÄ pii_types.py            # PII type definitions
‚îÇ
‚îú‚îÄ‚îÄ ‚öôÔ∏è processors/              # Document processing modules
‚îÇ   ‚îú‚îÄ‚îÄ digital_pdf_processor.py    # Digital PDF handling
‚îÇ   ‚îú‚îÄ‚îÄ scanned_pdf_processor.py    # Scanned PDF + OCR
‚îÇ   ‚îú‚îÄ‚îÄ image_processor.py          # Image processing
‚îÇ   ‚îú‚îÄ‚îÄ pdf_detector.py             # PDF type detection
‚îÇ   ‚îú‚îÄ‚îÄ qr_code_processor.py        # QR/Barcode detection
‚îÇ   ‚îú‚îÄ‚îÄ signature_processor.py     # Signature detection
‚îÇ   ‚îú‚îÄ‚îÄ text_label_processor.py    # Text labeling
‚îÇ   ‚îî‚îÄ‚îÄ metadata_processor.py      # Metadata cleaning
‚îÇ
‚îú‚îÄ‚îÄ üîç recognizers/             # Custom PII recognition
‚îÇ   ‚îú‚îÄ‚îÄ custom_recognizers.py      # Custom PII patterns
‚îÇ   ‚îî‚îÄ‚îÄ entity_types.py            # Entity type definitions
‚îÇ
‚îú‚îÄ‚îÄ üîß services/                # Background services
‚îÇ   ‚îú‚îÄ‚îÄ celery_service.py           # Celery configuration
‚îÇ   ‚îú‚îÄ‚îÄ tasks.py                    # Async task definitions
‚îÇ   ‚îú‚îÄ‚îÄ redaction.py               # Redaction orchestration
‚îÇ   ‚îî‚îÄ‚îÄ cleanup.py                 # File cleanup service
‚îÇ
‚îú‚îÄ‚îÄ üåê web/                     # Web interface components
‚îÇ   ‚îú‚îÄ‚îÄ app_factory.py             # Flask app factory
‚îÇ   ‚îú‚îÄ‚îÄ routes.py                   # Web route handlers
‚îÇ   ‚îî‚îÄ‚îÄ forms.py                    # Form definitions
‚îÇ
‚îú‚îÄ‚îÄ üõ†Ô∏è utils/                   # Utility functions
‚îÇ   ‚îî‚îÄ‚îÄ gpu_utils.py               # GPU management utilities
‚îÇ
‚îú‚îÄ‚îÄ üé® static/                  # Static web assets
‚îÇ   ‚îú‚îÄ‚îÄ style.css                  # Custom CSS
‚îÇ   ‚îú‚îÄ‚îÄ script.js                  # JavaScript
‚îÇ   ‚îî‚îÄ‚îÄ bootstrap.min.css          # Bootstrap CSS
‚îÇ
‚îî‚îÄ‚îÄ üìÑ templates/               # HTML templates
    ‚îú‚îÄ‚îÄ base.html                   # Base template
    ‚îú‚îÄ‚îÄ index.html                  # Main upload page
    ‚îú‚îÄ‚îÄ progress.html               # Progress tracking
    ‚îú‚îÄ‚îÄ result.html                 # Results display
    ‚îú‚îÄ‚îÄ 404.html                    # Error pages
    ‚îî‚îÄ‚îÄ 500.html

```

---

## üîÑ Data Flow

### üì• Document Processing Pipeline

```mermaid
sequenceDiagram
    participant User
    participant Flask
    participant Celery
    participant Processor
    participant AI_Engine
    participant Storage
    
    User->>Flask: Upload Document
    Flask->>Flask: Validate File
    Flask->>Storage: Save Upload
    Flask->>Celery: Queue Task
    Flask->>User: Return Task ID
    
    Celery->>Processor: Process Document
    Processor->>Processor: Detect Document Type
    
    alt Digital PDF
        Processor->>Processor: Extract Text
    else Scanned PDF/Image
        Processor->>AI_Engine: OCR Processing
        AI_Engine->>Processor: Extracted Text
    end
    
    Processor->>AI_Engine: PII Detection
    AI_Engine->>Processor: PII Entities
    Processor->>Processor: Apply Redactions
    Processor->>Storage: Save Result
    Processor->>Celery: Update Status
    
    User->>Flask: Check Status
    Flask->>User: Status Update
    User->>Flask: Download Result
    Flask->>Storage: Retrieve File
    Storage->>User: Redacted Document
```

### üîÑ Task Lifecycle

```mermaid
stateDiagram-v2
    [*] --> Queued: Task Submitted
    Queued --> Running: Worker Available
    Running --> Processing: Document Analysis
    Processing --> PII_Detection: Text Extracted
    PII_Detection --> Redaction: Entities Found
    Redaction --> Completed: File Saved
    Redaction --> Failed: Error Occurred
    Failed --> Retry: Retry Available
    Retry --> Running: Worker Available
    Completed --> [*]: Result Retrieved
    Failed --> [*]: Max Retries Exceeded
```

---

## üéØ Component Details

### üß† Core Components

#### `core/config.py` - Configuration Management

- **Purpose**: Centralized configuration loading and validation
- **Key Features**:
  - YAML configuration file support
  - Environment variable overrides
  - Default value fallbacks
  - Type validation and error handling

```python
# Configuration loading hierarchy:
# 1. Default values in DEFAULT_CONFIG
# 2. config.yaml file (if exists)
# 3. Environment variables (REDACTIFY_*)
# 4. Runtime overrides
```

#### `core/analyzers.py` - AI Engine Setup

- **Purpose**: Initialize and configure PII detection engines
- **Components**:
  - Presidio Analyzer setup
  - PaddleOCR initialization
  - Custom recognizer registration
  - GPU memory management

#### `core/pii_types.py` - PII Type System

- **Purpose**: Define supported PII types and categories
- **Features**:
  - Categorized PII types (Common, Advanced, Financial)
  - Friendly names for UI display
  - Extensible type system

### ‚öôÔ∏è Processors

#### `processors/pdf_detector.py` - Document Classification

- **Purpose**: Determine if PDF is digital or scanned
- **Logic**:
  - Attempts text extraction
  - Analyzes text-to-image ratio
  - Falls back to OCR if needed

#### `processors/digital_pdf_processor.py` - Digital PDF Handling

- **Purpose**: Process PDFs with extractable text
- **Features**:
  - Direct text extraction
  - Coordinate-based redaction
  - Metadata cleaning
  - Font and formatting preservation

#### `processors/scanned_pdf_processor.py` - OCR PDF Processing

- **Purpose**: Handle scanned PDFs requiring OCR
- **Process**:
  - Convert pages to images
  - OCR text extraction
  - Coordinate mapping
  - Image-based redaction

#### `processors/image_processor.py` - Image Processing

- **Purpose**: Process standalone images
- **Capabilities**:
  - Multiple format support
  - OCR text extraction
  - Bounding box redaction
  - Quality preservation

### üîç Recognition System

#### `recognizers/custom_recognizers.py` - Custom PII Patterns

- **Purpose**: Extend Presidio with custom recognizers
- **Examples**:
  - Indian Aadhaar numbers
  - PAN card numbers
  - Passport patterns
  - Custom regex patterns

#### `recognizers/entity_types.py` - Entity Definitions

- **Purpose**: Define entity types and metadata
- **Structure**:
  - Entity type constants
  - Recognition patterns
  - Confidence thresholds

### üîß Services Layer

#### `services/celery_service.py` - Task Queue Configuration

- **Purpose**: Configure Celery for async processing
- **Features**:
  - Redis broker setup
  - Task routing configuration
  - Worker pool management
  - Monitoring integration

#### `services/tasks.py` - Task Definitions

- **Purpose**: Define background processing tasks
- **Tasks**:
  - `perform_redaction` - Main processing task
  - `cleanup_expired_files` - Maintenance task
  - Progress tracking and error handling

### üåê Web Layer

#### `web/app_factory.py` - Application Factory

- **Purpose**: Create and configure Flask application
- **Features**:
  - Environment-specific configuration
  - Extension initialization
  - Error handler registration
  - Security settings

#### `web/routes.py` - Route Handlers

- **Purpose**: Handle HTTP requests and responses
- **Endpoints**:
  - File upload and validation
  - Task status monitoring
  - Result download
  - API endpoints

---

## üîß Design Patterns

### üè≠ Factory Pattern

- **Used in**: Flask app creation, processor instantiation
- **Benefits**: Flexible configuration, easier testing

### üé≠ Strategy Pattern

- **Used in**: Document processor selection
- **Benefits**: Runtime processor switching based on document type

### üîç Observer Pattern

- **Used in**: Task progress monitoring
- **Benefits**: Real-time status updates

### üèóÔ∏è Builder Pattern

- **Used in**: Configuration building
- **Benefits**: Step-by-step configuration construction

### üîå Plugin Pattern

- **Used in**: Custom recognizer system
- **Benefits**: Extensible PII detection

---

## üöÄ Scalability

### üìà Horizontal Scaling

#### Worker Scaling

```python
# Scale workers based on load
celery worker --concurrency=8  # More workers per process
docker-compose up --scale worker=4  # More worker containers
```

#### Queue Partitioning

```python
# Separate queues for different workloads
TASK_ROUTES = {
    'heavy_processing': {'queue': 'gpu_queue'},
    'light_processing': {'queue': 'cpu_queue'},
    'maintenance': {'queue': 'maintenance_queue'}
}
```

### ‚ö° Performance Optimization

#### GPU Utilization

- **Memory Management**: Configurable GPU memory allocation
- **Batch Processing**: Process multiple documents in batches
- **Model Caching**: Reuse loaded models across tasks

#### Caching Strategy

- **Redis Caching**: Cache frequently accessed data
- **Model Caching**: Keep AI models in memory
- **Result Caching**: Cache processing results

### üìä Load Balancing

#### Service Distribution

```yaml
# Docker Compose scaling
services:
  web:
    replicas: 2
  worker-redaction:
    replicas: 4
  worker-maintenance:
    replicas: 1
```

---

## üîí Security Architecture

### üõ°Ô∏è Security Layers

#### Input Validation

- File type validation
- Size limit enforcement
- Content scanning
- Sanitization

#### Processing Security

- Isolated file processing
- Temporary file cleanup
- Memory limit enforcement
- Resource monitoring

#### Output Security

- Secure file serving
- Access control
- Audit logging
- Data encryption (configurable)

### üîê Data Protection

#### File Lifecycle Management

```python
# Secure file handling
1. Upload ‚Üí Validation ‚Üí Temporary Storage
2. Processing ‚Üí Isolated Environment
3. Output ‚Üí Secure Serving
4. Cleanup ‚Üí Automatic Deletion
```

#### Access Control

- Request rate limiting
- IP-based restrictions (configurable)
- Authentication hooks (extensible)
- Authorization middleware

---

<div align="center">

## üéØ Architecture Summary

| Layer | Purpose | Key Components | Scalability |
|-------|---------|----------------|-------------|
| **Web** | User Interface | Flask, Routes, Templates | Load Balancer |
| **Queue** | Task Management | Celery, Redis, Beat | Worker Scaling |
| **Processing** | Document Handling | Processors, OCR, AI | GPU Acceleration |
| **Storage** | Data Persistence | Files, Cache, Results | Distributed Storage |

---

**Need More Details?** üìñ [Component Documentation](components/) | üîß [Configuration Guide](configuration.md) | üöÄ [Deployment Guide](deployment.md)

</div>
