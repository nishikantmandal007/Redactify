{% extends "bootstrap/base.html" %}

{% block title %}Redaction Progress{% endblock %}

{% block content %}
<div class="container mt-4">
    <h1>Redaction Progress</h1>
    <hr>

    <p><strong>Task ID:</strong> {{ task_id }}</p>

    <div id="status-message" class="alert alert-info" role="alert">
        Loading status...
    </div>

    <div class="progress" style="height: 25px;">
        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
            style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
            <span id="progress-text">0%</span>
        </div>
    </div>

    <div id="result-link" class="mt-3" style="display: none;">
        <a href="#" id="download-button" class="btn btn-success">Download Redacted PDF</a>
    </div>

    <div class="mt-3">
        <a href="{{ url_for('index') }}" class="btn btn-secondary">Upload Another File</a>
    </div>

</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    function updateProgress() {
        const taskId = "{{ task_id }}";
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const statusMessageDiv = document.getElementById('status-message');
        const resultLinkDiv = document.getElementById('result-link');
        const downloadButton = document.getElementById('download-button');

        fetch(`/task_status/${taskId}`)
            .then(response => response.json())
            .then(data => {
                // Update progress bar
                const progressPercent = Math.min(data.progress || 0, 100); // Ensure max 100
                progressBar.style.width = progressPercent + '%';
                progressBar.setAttribute('aria-valuenow', progressPercent);
                progressText.textContent = progressPercent + '%';

                // Update status message and its alert type
                statusMessageDiv.textContent = data.status || 'Waiting...';
                statusMessageDiv.className = 'alert'; // Reset classes
                if (data.state === 'SUCCESS') {
                    statusMessageDiv.classList.add('alert-success');
                    progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                    progressBar.classList.add('bg-success');
                } else if (data.state === 'FAILURE') {
                    statusMessageDiv.classList.add('alert-danger');
                    progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                    progressBar.classList.add('bg-danger');
                } else if (data.state === 'RETRY') {
                    statusMessageDiv.classList.add('alert-warning');
                    progressBar.classList.add('progress-bar-animated', 'progress-bar-striped'); // Keep animated during retry
                }
                else {
                    statusMessageDiv.classList.add('alert-info');
                    progressBar.classList.add('progress-bar-animated', 'progress-bar-striped');
                }


                // Handle completion states
                if (data.state === 'SUCCESS') {
                    if (data.result) {
                        downloadButton.href = `/result/${taskId}`; // Link to result endpoint
                        resultLinkDiv.style.display = 'block'; // Show download link
                    } else {
                        statusMessageDiv.textContent = 'Task completed, but result file is missing!';
                        statusMessageDiv.className = 'alert alert-warning';
                    }
                    // Stop polling on success
                    clearInterval(intervalId);
                } else if (data.state === 'FAILURE') {
                    // Stop polling on failure
                    clearInterval(intervalId);
                }
            })
            .catch(error => {
                console.error('Error fetching task status:', error);
                statusMessageDiv.textContent = 'Error fetching status. Please check console or try again later.';
                statusMessageDiv.className = 'alert alert-danger';
                // Consider stopping polling on fetch error?
                // clearInterval(intervalId);
            });
    }

    // Poll every 2 seconds (adjust as needed)
    const intervalId = setInterval(updateProgress, 2000);

    // Initial call to update status immediately
    updateProgress();
</script>
{% endblock %}